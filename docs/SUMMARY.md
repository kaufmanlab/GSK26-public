# GSK26-public Codebase Summary

Analysis pipeline for mouse motor cortex (M1/S1) two-photon calcium imaging during reaching and grasping. DeepLabCut tracks 15 body markers; custom inverse kinematics extracts 24 joint angles. 5 mice (cfa17, cfa19, cfa20, cfa22, cfa24), each with M1 and S1 imaging sessions. Generates Figures 1-6 for publication.

This summary was generated by a Claude Code instance prompted to summarize code into an easily digestible format without changing it in any way.

## Getting Started

1. Set `YOURDATAPATH` to the directory containing `.mat` data files
2. Add all subdirectories to the MATLAB path
3. Run `fig#_analysis.m` to compute results (slow), or `fig#_main.m` to plot from saved results

## Directory Structure

```
GSK26-public/
├── main/
│   ├── fig1/                  Motor behavior & kinematics overview
│   │   ├── fig1_main.m
│   │   └── plots/             6 plotting functions
│   ├── fig2/                  Paw aperture kinematics
│   │   ├── fig2_main.m
│   │   ├── analysis/          1 analysis function
│   │   └── plots/             5 plotting functions
│   ├── fig3/                  Joint angle kinematics & dimensionality
│   │   ├── fig3_main.m
│   │   ├── analysis/          2 analysis functions
│   │   └── plots/             5 plotting functions
│   ├── fig4/                  Neural recording sites & modulation
│   │   ├── fig4_main.m
│   │   └── plots/             3 plotting functions
│   ├── fig5/                  Neural decoding of kinematics
│   │   ├── fig5_main.m, fig5_analysis.m, fig5_supp1-3.m
│   │   ├── analysis/          14 analysis functions
│   │   └── plots/             7 plotting functions
│   └── fig6/                  Target classification from neural activity
│       ├── fig6_main.m, fig6_analysis.m, fig6_supp1.m
│       ├── analysis/          13 analysis functions
│       └── plots/             5 plotting functions
├── preproc/                   13 preprocessing & data loading functions
└── utils/                     22 utility functions + 1 data file
```

---

# main/fig1/ — Motor Behavior & Kinematics Overview

## fig1_main.m (Script)

Generates Figure 1 panels A-I. Loads mouse cfa17/200825 for trajectory and skeleton visualizations (panels A-C), multi-event locked to `liftTimeDLC` and `grabTimeC`. Loads all 5 mice for behavioral timing distributions (panels D-G). Loads optogenetic data for inactivation histograms (panel H) and opto trajectories (panel I).

**Panel calls:**
- B: `plotSkeleton(posXYZ, M.plotParams, view)` — 5 skeleton poses from trial 2
- C: `plotTrajectories(kinematics, M.plotParams)` — all-trial 3D trajectories
- D-F: `plotEventTimeDistributions(eventInfo, eventName, yLim, zeroLabel)` — liftRT, lift2ZoneTimes, lift2ContactTimes
- G: `plotNContactsDistributions(eventInfo)` — grasp count distributions
- H: `plotOptoHists(optoData)` — contact time histograms under M1 inactivation
- I: `plotOptoTrajectories(kinematics, M.plotParams)` — opto vs control trajectories

## plots/

### plotTrajectories.m
```matlab
function plotTrajectories(kinematics, plotParams)
```
Plots 3D reach trajectories for left and right trials with spout positions, lift-time markers, and contact-time markers. Computes mean position across first 4 markers (fingertip centroid). Blue for left, red for right. 3D view at [-22, 4].

- **kinematics** — struct array with `.LR`, `.posXYZ` (time x 3 x markers), `.tPts`, `.eventInterval`
- **plotParams** — struct with `.spoutPose` (4x3), `.traceColors`, `.traceAlpha`, `.traceLineWidth`

```matlab
plotTrajectories(kinematics, M.plotParams)
```

### plotSkeleton.m
```matlab
function plotSkeleton(posXYZ, plotParams, view)
```
Plots a sequence of skeleton poses side by side, offset in X, for visualizing posture at multiple time points. Centers each pose on marker 15 (shoulder).

- **posXYZ** — nTimePoints x 3 x nMarkers position data
- **plotParams** — struct for `drawSkeleton()` and `drawMarkers()`
- **view** — [azimuth, elevation] for 3D view

```matlab
plotSkeleton(posXYZ, M.plotParams, [-17, 7])
```

### plotOptoHists.m
```matlab
function plotOptoHists(data)
```
Histograms comparing contact times for normal (black) vs optogenetic stimulation (cyan) trials, showing effect of M1 inactivation on reach timing. Probability-normalized, stairs style, 30 bins from 0-9s.

- **data** — struct array with `.success`, `.optoProblem`, `.optoTrial`, `.grabTimeC`, `.liftTimeC`, `.wrongGrabFirst`

```matlab
plotOptoHists(optoData)
```

### plotNContactsDistributions.m
```matlab
function plotNContactsDistributions(eventInfo)
```
Bar charts showing distribution of number of spout contacts within 1 second of cue, comparing left (blue) and right (red).

- **eventInfo** — struct array with `.nGrasps_R`, `.nGrasps_L`

```matlab
plotNContactsDistributions(eventInfo)
```

### plotEventTimeDistributions.m
```matlab
function plotEventTimeDistributions(eventInfo, eventName, yLim, zeroLabel)
```
Box-and-whisker distributions for event timing across 5 mice, separated by left vs right trials.

- **eventInfo** — struct array (1 per mouse), fields accessed as `eventInfo.([eventName '_L'])` and `_R`
- **eventName** — base field name (e.g., `'liftRT'`, `'lift2ContactTimes'`)
- **yLim** — [min, max] for Y axis
- **zeroLabel** — label for the zero tick (e.g., `'cue'` or `'lift'`)

```matlab
plotEventTimeDistributions(eventInfo, 'liftRT', [-55, 500], 'cue')
plotEventTimeDistributions(eventInfo, 'lift2ZoneTimes', [-55, 1000], 'lift')
plotEventTimeDistributions(eventInfo, 'lift2ContactTimes', [-55, 1000], 'lift')
```

### plotOptoTrajectories.m
```matlab
function plotOptoTrajectories(kinematics, plotParams)
```
3D fingertip trajectories from an optogenetic inactivation session. Opto trials in cyan (alpha=0.4), control trials in gray (alpha=0.6, max 60 trials). Right-target trials only.

- **kinematics** — struct array with `.LR`, `.optoTrial`, `.tPts`, `.posXYZ`
- **plotParams** — struct with trace drawing parameters

```matlab
plotOptoTrajectories(kinematics, M.plotParams)
```

---

# main/fig2/ — Paw Aperture Kinematics

## fig2_main.m (Script)

Generates Figure 2 panels A-E. Loads 10 sessions from 5 mice via `loadMultilockKinematicsAll()`. Focuses on paw aperture analysis during grasping: polygon visualization, aperture time series, event timing histograms, trajectory annotations, and aperture spreads.

**Panel calls:**
- A: `plotAperturePolygon(kinematics(trial), M.plotParams)` — skeleton with aperture fill polygon
- B: `plotApertureTimeSeries(kinematics(trial))` — dual-axis aperture + Z velocity
- C: `plotApertureEventHists(kinematics)` — collect/extend timing distributions
- D: `plotTrajectoryApertureEvents(kinematics(trials))` — 3D trajectories with event markers
- E: `plotApertureSpreads(kinematics)` — median aperture with percentile bands

## analysis/

### apertureFeatures.m
```matlab
function kinematics = apertureFeatures(kinematics)
```
Computes aperture-related kinematic features for each trial: max Z velocity timing, the "collect" event (aperture minimum near contact), and the "extend" event (aperture peak after collect).

- **kinematics** — struct array with `.CvelXYZ`, `.tPts`, `.eventInterval`, `.aperture`
- **Returns** same struct with added fields:
  - `.maxZVelBin`, `.maxZVelTime` — bin/time of maximum Z velocity
  - `.nPeaks`, `.zPeaks` — number and locations of Z velocity peaks (>20 mm/s)
  - `.collectBin`, `.collectTime` — aperture minimum closest to max Z velocity
  - `.extendBin`, `.extendTime` — first aperture peak after collect

Collect event found via `findpeaks(-aperture)` near maxZVelBin. Extend found via `findpeaks(aperture)` after collectBin, requiring >= 3 bin separation. Called internally by `loadMultilockKinematicsAll()`.

## plots/

### plotAperturePolygon.m
```matlab
function plotAperturePolygon(data, plotParams)
```
Plots hand skeleton at three key time points (lift, collect, extend) with a filled polygon across the paw representing the aperture. Uses `drawSkeleton()`, `drawMarkers()`, and `drawFill()`.

- **data** — single trial struct with `.tPts`, `.collectBin`, `.extendBin`, `.posXYZ`
- **plotParams** — struct with `.markers2Plot`, `.skeleton2Plot`, `.fillColor`, `.fillAlpha`, `.markers2Fill`

```matlab
plotAperturePolygon(kinematics(trial), M.plotParams)
```

### plotApertureTimeSeries.m
```matlab
function plotApertureTimeSeries(data)
```
Dual-axis time series for a single trial: normalized aperture (orange) and Z velocity (black), with dashed vertical lines at lift, max-Z-speed, collect, and extend events.

- **data** — single trial struct with `.tPts`, `.CvelXYZ`, `.aperture`, `.collectBin`, `.extendBin`

```matlab
plotApertureTimeSeries(kinematics(trial))
```

### plotApertureEventHists.m
```matlab
function plotApertureEventHists(kinematics)
```
Histograms of collect (blue) and extend (pink) event timing, separated by left and right trials. Only includes trials with exactly 1 Z velocity peak.

- **kinematics** — struct array with `.LR`, `.nPeaks`, `.collectTime`, `.extendTime`

```matlab
plotApertureEventHists(kinematics)
```

### plotTrajectoryApertureEvents.m
```matlab
function plotTrajectoryApertureEvents(kinematics)
```
3D centroid trajectories with colored markers at lift (green), collect (blue), and extend (pink) events. Only trials with valid events and nPeaks==1.

- **kinematics** — struct array with `.CposXYZ`, `.LR`, `.collectBin`, `.extendBin`, `.nPeaks`, `.tPts`

```matlab
plotTrajectoryApertureEvents(kinematics(trials))
```

### plotApertureSpreads.m
```matlab
function plotApertureSpreads(kinematics, maxpeaks)
```
Median aperture time series with 25th/75th percentile shaded spreads, aligned to max Z velocity. Shows left (blue) and right (red) for each mouse, stacked vertically.

- **kinematics** — struct array
- **maxpeaks** — (optional, default 3) max Z velocity peaks to include a trial

Contains local function `alignAperture(kinematics, nbefore, nafter)` to extract windows around maxZVelBin.

```matlab
plotApertureSpreads(kinematics)
```

---

# main/fig3/ — Joint Angle Kinematics & Dimensionality

## fig3_main.m (Script)

Generates Figure 3 panels A-E. Single-mouse data (cfa17/200825) for skeleton Euler angle visualization and joint angle time series. All-mice data for correlation matrices and cross-validated PCA dimensionality analysis.

**Panel calls:**
- A: `plotSkeletonEulerAngles(kinematics(trial), tPt, M.plotParams, view)`
- B: `plotJointAnglesVertical(kinematics, [1,4,5,8,21])` — shoulder, elbow, wrist, MCP1, PIP1 flexion
- C: `plotJointAngleCorr(kinematics, 'jointAngles')`
- D: `plotJointKinematicsCVPCALoss(lossTests, lossSEMs, 1, 16)` — mouse 1 loss curve
- E: `plotJointKinematicsCVPCA(lossTests)` — all-mice dimensionality comparison

## analysis/

### crossvalPCAYu.m
```matlab
function [best, lossTest, lossTestSEMs, lossTrain] = crossvalPCAYu(data, labels, maxDim, method, nFolds, nVars)
```
Cross-validated PCA using Byron Yu's double-holdout method for dimensionality selection. Holds out observations by fold label, then for each fold holds out one variable at a time, reconstructs via regression, and computes loss.

- **data** — (observations x variables) matrix
- **labels** — (observations x 1) fold assignment vector
- **maxDim** — (optional, default 20) max dimensions to test
- **method** — (optional, default `'var'`) loss type: `'var'` = squared-error, `'corr'` = 1-R^2
- **nFolds** — (optional, default all) number of CV folds
- **nVars** — (optional, default all) variables to rotate through
- **Returns:**
  - `best` — optimal dimensionality (lowest test loss)
  - `lossTest` — 1 x maxDim mean test loss
  - `lossTestSEMs` — 1 x maxDim SEM
  - `lossTrain` — 1 x maxDim train loss (monotonically decreasing)

### jointKinematicsCVPCA.m
```matlab
function [lossTests, lossSEMs] = jointKinematicsCVPCA(kinematicsAll, maxDims, nLabels)
```
Runs cross-validated PCA on joint angles and joint velocities for each mouse separately. Assigns random fold labels per trial, excludes contact bins, standardizes by std.

- **kinematicsAll** — struct array with `.animalID`, `.jointAngles`, `.jointVelocities`, `.contactBins`
- **maxDims** — (optional, default 16)
- **nLabels** — (optional, default 5) for 5-fold CV
- **Returns:**
  - `lossTests` — nMice x maxDims x 2 (dim 3: 1=angles, 2=velocities)
  - `lossSEMs` — same shape

```matlab
[lossTests, lossSEMs] = jointKinematicsCVPCA(kinematics)
```

## plots/

### plotSkeletonEulerAngles.m
```matlab
function plotSkeletonEulerAngles(data, tPt, plotParams, view)
```
Skeleton pose with RGB coordinate frames (XYZ arrows via `arrow3D()`) at shoulder, elbow, and wrist, showing how Euler angle decomposition works. Uses `rodriguesRot()` for cumulative joint rotations.

```matlab
plotSkeletonEulerAngles(kinematics(trial), tPt, M.plotParams, [-42, 10.5])
```

### plotJointAnglesVertical.m
```matlab
function plotJointAnglesVertical(kinematics, joints)
```
Time series of selected joint angles for all trials. Left (blue, alpha=0.2) and right (red, alpha=0.2) side-by-side, joints stacked vertically. 24 joint names defined internally.

```matlab
plotJointAnglesVertical(kinematics, [1,4,5,8,21])
```

### plotJointAngleCorr.m
```matlab
function plotJointAngleCorr(kinematicsAll, field)
```
Correlation matrices of joint angle (or velocity) data per mouse in a 3-top/2-bottom grid. Diverging yellow-teal colormap, clim [-1, 1].

```matlab
plotJointAngleCorr(kinematics, 'jointAngles')
```

### plotJointKinematicsCVPCA.m
```matlab
function plotJointKinematicsCVPCA(lossTests)
```
Paired dot-plot of best dimensionality for angles (x=1) vs velocities (x=2) across mice. Each mouse has a unique marker and color.

### plotJointKinematicsCVPCALoss.m
```matlab
function plotJointKinematicsCVPCALoss(lossTests, lossSEMs, mouseN, maxDims)
```
CV-PCA loss curve with SEM error bars for a single mouse. Angles in black, velocities in gray. Best dimensionality marked with large dot.

```matlab
plotJointKinematicsCVPCALoss(lossTests, lossSEMs, 1, 16)
```

---

# main/fig4/ — Neural Recording Sites & Modulation

## fig4_main.m (Script)

Generates Figure 4 panels A-D. Defines FOV locations (AP/ML coordinates) and rotations for 5 mice. Loads ZETA modulation scores. Generates raster/PETH plots for example neurons locked to waterTime, liftTimeDLC, and grabTimeC.

## plots/

### plotFOVsAllenCCF.m
```matlab
function plotFOVsAllenCCF(locsM1, locsS1, rotations)
```
Plots fields of view as rotated rectangles (0.81 x 1 mm) on the Allen CCF dorsal cortical map. Each mouse gets a unique color.

- **locsM1** — 5x2 matrix (AP, ML in mm from bregma)
- **locsS1** — 5x2 matrix
- **rotations** — 5x2 matrix of degrees

```matlab
plotFOVsAllenCCF(locsM1, locsS1, rotations)
```

### plotZETAScores.m
```matlab
function plotZETAScores(modScores, thresh)
```
Scatter plot of log10(p-values) from ZETA modulation tests. Colors: red=right-tuned, blue=left-tuned, fuschia=both, grey=not modulated. Saturation scaled by magnitude.

- **modScores** — 2xN matrix of p-values (row 1=left, row 2=right)
- **thresh** — significance threshold (e.g., 0.025)

```matlab
plotZETAScores(modScoresM1, 0.025)
```

### rasterPETH.m
```matlab
function rasterPETH(R, M, roi, eventName, preEventMs, postEventMs, clusField, sortField, plotRaster)
```
Peri-event time histogram with SEM shading and optional single-trial raster heatmap. Clusters trials by `clusField`, plots mean +/- SEM per cluster.

- **R** — trial struct array
- **M** — metadata struct with `.cmapClus`
- **roi** — neuron index
- **eventName** — event to lock to (e.g., `'liftTimeDLC'`)
- **preEventMs/postEventMs** — time window
- **clusField** — cluster field name (e.g., `'movementTimeClus'`)
- **sortField** — sort field for raster (e.g., `'movementTime'`)
- **plotRaster** — (optional, default 1) show raster

Local subfunctions: `computeLockedTraces`, `plotPSTHSection`, `plotRasterSection`.

```matlab
rasterPETH(R, M, roi, 'liftTimeDLC', 100, 700, 'movementTimeClus', 'movementTime')
```

---

# main/fig5/ — Neural Decoding of Kinematics

## fig5_main.m (Script)

Loads pre-computed regression outputs (RADICaL rates, joint angles) for M1 and S1. Generates panels A-H: single-mouse variance-explained violin plots, joint angle time series with reconstructions, 3D skeleton reconstructions at median-VE trials, and all-mice summary scatter plots.

## fig5_analysis.m (Script)

Runs all regression analyses with `rng(240926)` for reproducibility. Six model configurations:
1. Instantaneous — same-time neural-to-kinematic regression
2. Proximal-distal partial — removes mutual proximal/distal correlations
3. Distance-to-spout partial — removes spout distance confound
4. Residual — mean-subtracted, separate L/R
5. Causal Wiener filter — lags -100:20:0 ms
6. Acausal Wiener filter — lags -100:20:100 ms

Tests on joint angles + velocities, RADICaL rates + smoothed deconvolved.

## fig5_supp1.m (Script)
Plots smoothed-deconvolved angle decoding and RADICaL velocity decoding for all mice.

## fig5_supp2.m (Script)
Plots proximal/distal partial, distance-to-spout partial, and variance vs VE scatter.

## fig5_supp3.m (Script)
Plots residual decoding (L/R separate) and causal/acausal Wiener filter decoding.

## analysis/

### cvRegress.m
```matlab
function output = cvRegress(predictors, outcomes, nPartitions, nFolds, regType, fields, verbose)
```
Core cross-validated regression engine. K-fold CV repeated over multiple random partitions. Total models = nFolds x nPartitions (default 50).

- **predictors** — struct array with `.data` (obs x predictors), `.trialNumber`
- **outcomes** — struct array with `.data` (obs x outcomes), `.trialNumber`
- **nPartitions** — (default 10) random partition count
- **nFolds** — (default 5) folds per partition
- **regType** — `'ridge'` (default) or `'ols'`
- **fields** — (default `{'data','data'}`) field names to use
- **verbose** — (default 1)
- **Returns** struct with:
  - `.VEs` — nModels x nOutcomes variance explained on test set
  - `.trainVEs`, `.medianVEs` — training VE and median across folds
  - `.betas` — cell array of regression coefficients
  - `.trainInds`, `.testInds`, `.trialsTest` — fold assignments

VE = 1 - var(residual)/var(actual).

### ridgeMML.m
```matlab
function [L, betas, convergenceFailures] = ridgeMML(Y, X, recenter, L)
```
Ridge regression with regularization parameter lambda determined via marginal maximum likelihood (Karabatsos 2017). Uses SVD for efficient computation.

- **Y** — (obs x outcomes) response matrix
- **X** — (obs x predictors) design matrix, NO column of ones
- **recenter** — (default 1) if 1, z-scores X and recenters Y
- **L** — (optional) pre-computed lambda values
- **Returns:**
  - `L` — 1 x nOutcomes lambda vector
  - `betas` — coefficients (if recenter=0, first row is intercept)
  - `convergenceFailures` — logical vector

Algorithm: two-step Karabatsos approach (coarse grid + fminbnd refinement) with boxcar smoothing (width 7) to avoid local minima.

### decode.m
```matlab
function output = decode(kinematics, neurons, tBins, ROIs, kinematicField, neuralField)
```
Fits instantaneous (same-time) regression from neural data to kinematics using cross-validated ridge regression. Applies PCA to neural data (90% variance threshold).

- **kinematicField** — e.g., `'jointAngles'`
- **neuralField** — e.g., `'radical_rates'`

Calls `pca4Regression()` then `cvRegress()` (5 folds, 10 partitions).

### decodeWiener.m
```matlab
function output = decodeWiener(kinematics, neurons, tPts, ROIs, lags, kinematicField, neuralField)
```
Fits lagged Wiener filter model. Builds time-lagged neural data matrices and column-concatenates them. `lags` must contain 0.

- Causal: `lags = -100:20:0`
- Acausal: `lags = -100:20:100`

### baggedDecode.m
```matlab
function decodeSummary = baggedDecode(decodeSummary, field)
```
Bagged (averaged) reconstruction across CV folds. For each trial, averages betas from all folds where that trial was in the test set. Computes per-trial, per-joint VE. If field is `'jointAngles'`, also runs forward kinematics to reconstruct 3D positions.

### decodePartialD2S.m
```matlab
function output = decodePartialD2S(kinematics, neurons, tBins, ROIs, kinematicField, neuralField)
```
Regression after removing distance-to-spout correlation from joint angles. Computes mean X-distance from MCP joints (markers 9-12) to spout, regresses with `ridgeMML`, subtracts prediction.

### decodePartialPrxDst.m
```matlab
function output = decodePartialPrxDst(kinematics, neurons, tBins, ROIs, kinematicField, neuralField)
```
Regression after removing mutual correlations between proximal (joints 1-7: shoulder/elbow/wrist) and distal (joints 8-24: fingers) joint angles. Bidirectional ridge regression, subtracts each prediction from the other.

### decodeResiduals.m
```matlab
function output = decodeResiduals(kinematics, neurons, tBins, ROIs, kinematicField, neuralField)
```
Regression on trial-to-trial residuals (mean-subtracted data) separately for left and right conditions. Returns struct with `.outputL` and `.outputR`.

### pca4Regression.m
```matlab
function [data, V, ve] = pca4Regression(data, nPCs, rotate, denoise, meanSubtract)
```
PCA dimensionality reduction on concatenated trial data for neural regression.

- **nPCs** — number of PCs (if <1, interpreted as fraction of total variance)
- **rotate** — (default 0) if 1, applies random orthogonal rotation (control)
- **denoise** — (default 0) if 1, reconstructs from top PCs; if 0, returns raw scores
- **meanSubtract** — (default 0) if 1, mean-subtracts and range-normalizes

### inverseKinematics_PD_vAF.m
```matlab
function [jointAngles, posXYZn, n_PIPs] = inverseKinematics_PD_vAF(posXYZ)
```
Extracts 24 joint angles from 3D marker positions (15 markers). Joint order:

| Index | Joint | Description |
|-------|-------|-------------|
| 1-3 | SHLDf/a/r | Shoulder flexion, abduction, rotation |
| 4 | ELBOf | Elbow flexion |
| 5-7 | WRSTf/d/r | Wrist flexion, deviation, rotation |
| 8-11 | MCP1-4f | MCP flexion (4 digits) |
| 12-15 | MCP1-4a | MCP abduction/adduction |
| 16-17 | MC1/4o | Metacarpal opposition |
| 18-20 | P1-2/2-3/3-4 | Inter-digit splay |
| 21-24 | PIP1-4f | PIP flexion (4 digits) |

Uses "Method 2": abd/add removed first, then flexion, for shoulder and wrist.

### forwardKinematics_PD_vAF.m
```matlab
function posXYZout = forwardKinematics_PD_vAF(posXYZ, jointAngles)
```
Inverse of `inverseKinematics_PD_vAF`. Reconstructs 3D marker positions from 24 joint angles. Uses Rodrigues rotations applied in reverse order (PIP -> splay -> MCP -> wrist -> elbow -> shoulder).

### rodriguesRot.m
```matlab
function vrot = rodriguesRot(v, k, theta, angle_type)
```
Rodrigues rotation formula: rotates vector `v` by angle `theta` around axis `k`.

- **angle_type** — `'degrees'` (default) or `'radians'`

### loadDecode.m
```matlab
function [output, outputPrxDst, outputD2S, outputRes, outputWc, outputWa] = loadDecode(dataPath, mouse, session, kinematicField, neuralField, fitModels)
```
Runs all 6 decoding model configurations for one dataset. Loads `{mouse}_{session}_liftLocked.mat`. Screens to top 100 ZETA-modulated neurons. Time window: -100 to 400 ms.

- **fitModels** — optional 1x6 logical (default all ones) selecting which models to run

### loadDecodeAll.m
```matlab
function outputs = loadDecodeAll(dataPath, datasets, kinematicField, neuralField, fitModels)
```
Wrapper looping `loadDecode` over all 5 mice. Returns struct array with `.mouse`, `.output`, `.outputPrxDst`, `.outputD2S`, `.outputResL`, `.outputResR`, `.outputWc`, `.outputWa`.

## plots/

### plotVE.m
```matlab
function plotVE(output, inverty)
```
Variance explained for all 24 joints as violin/scatter plots. Proximal joints in magenta, distal in orange. Reference lines at VE = 0, 0.25, 0.5, 0.75, 1.0.

```matlab
plotVE(outputsM1_rr(1).output, 0)
```

### violin.m
```matlab
function violin(hA, Y, axLoc, color, alpha, mrkSz, mxStr, txtCol, fntSz, bw)
```
Single violin plot: kernel density estimate via `ksdensity()`, scatter of jittered individual points, median line. Supports horizontal and vertical orientations.

### violins.m
```matlab
function violins(hA, vals, names, cmap, axvals, ax, alpha, mrkSz, linesmin, linesmax, nlines)
```
Multiple violin plots on a single axis with dashed reference lines. Loops over columns calling `violin()`.

### jointsReconPlot.m
```matlab
function ylims = jointsReconPlot(output, joints, field, ylims)
```
Joint angle time series overlaid with neural reconstructions. 2 rows (L/R) x nJoints columns. Black = actual, colored = reconstruction.

```matlab
jointsReconPlot(outputsM1_rr(1).output, joints, 'jointAngles')
```

### reconPosePlot.m
```matlab
function reconPosePlot(output, M, trialIdx, frames, offsets)
```
3D skeleton poses at multiple frames for one trial. Original (grey) vs reconstructed (blue/red) side by side. Uses `drawMarkers()`, `drawSkeleton()`.

```matlab
reconPosePlot(outputsM1_rr(1).output, M, trialIdx, frames, offsets)
```

### plotVEAll.m
```matlab
function plotVEAll(outputs, field, inverty)
```
VE summary for all 5 mice. Median VE per joint as scatter (magenta=proximal, orange=distal) with grand median line.

```matlab
plotVEAll(outputsM1_rr, 'output', 0)
```

### plotVEvsVar.m
```matlab
function plotVEvsVar(outputs, field)
```
Scatter of joint variance vs variance explained. Different marker shapes per mouse.

---

# main/fig6/ — Target Classification from Neural Activity

## fig6_main.m (Script)

Loads pre-computed classifier outputs. Generates panels A-D: single-trial classifier projections, threshold crossing time distributions, real vs decoded RT correlations, and cross-time generalization heatmaps.

## fig6_analysis.m (Script)

Runs four classifier types via `loadClassifierAll()`: target (L/R), reaction time, cross-time generalization, and kinematics-partialed target.

## fig6_supp1.m (Script)

Plots time-resolved classifier performance for target and partial-target decoders.

## analysis/

### cvClassifier.m
```matlab
function output = cvClassifier(data, nFolds, nPartitions, type, reg)
```
Cross-validated linear classifier for binary classification. Uses MATLAB's `fitclinear()`.

- **data** — struct array with `.data` (time x predictors), `.label` (scalar class), `.labels` (per-row class vector), `.trialNumber`
- **nFolds** — (default 1) folds per partition
- **nPartitions** — (default 5) partitions (80/20 split)
- **type** — `'logistic'` (default) or `'svm'`
- **reg** — `'ridge'` (default)
- **Returns** struct array (1 per model) with `.betas`, `.bias`, `.model`, `.predLabels`, `.performance`

Training sets stratified via `stratify()`. Performance = percent correct.

### stratify.m
```matlab
function [keptIdx, droppedIdx] = stratify(labels)
```
Balances binary labels by downsampling the larger class to match the smaller.

### projectClassifier.m
```matlab
function output = projectClassifier(output, data, method)
```
Projects single-trial time series onto the fitted classifier dimension. Methods: `'allnorm'` (normalize by 90th percentile) or `'normLR'` (normalize L and R separately).

### targetClassifier.m
```matlab
function output = targetClassifier(data, config)
```
Fits L/R target classifier on post-cue neural data (50ms to postT). 1 fold, 5 partitions. Projects full time series, computes threshold crossing times (first sustained 5+ bin crossing), and per-bin performance.

Local subfunctions: `getPredictors`, `analyzeClassifier`, `projectBins`.

### targetPartialClassifier.m
```matlab
function output = targetPartialClassifier(data, kinematics, config)
```
Target classifier after first regressing out joint angle information from neural data via `ridgeMML`. Computes per-bin performance but does NOT project or compute thresholds.

### rtClassifier.m
```matlab
function output = rtClassifier(data, config)
```
Predicts reaction time from neural activity. Applies PCA (10 dims), averages pre-event (-100:-10 ms) and post-event (10:100 ms) neural data, trains pre/post classifier. Crossing time serves as decoded RT.

### targetXTClassifier.m
```matlab
function outputs = targetXTClassifier(data, config)
```
Cross-time generalization analysis. Trains target classifiers on non-overlapping 100ms epochs, tests on all individual 10ms bins. Result: train-epoch x test-bin performance matrix.

### findSubsequences.m
```matlab
function [subsequences, lengths] = findSubsequences(sequence)
```
Finds contiguous runs of 1s in a binary vector. Used for sustained threshold crossing detection.

### loadClassifierAll.m
```matlab
function outputs = loadClassifierAll(dataPath, datasets, model)
```
Wrapper looping over 5 mice, loading both M1 and S1 sessions. Dispatches to load function by model type: `'target'`, `'RT'`, `'targetXT'`, `'targetPartial'`.

### loadTargetClassifier.m
```matlab
function output = loadTargetClassifier(dataPath, mouse, session)
```
Loads `{mouse}_{session}_cueLocked.mat`, runs `targetClassifier` with logistic type.

### loadRTClassifier.m
```matlab
function output = loadRTClassifier(dataPath, mouse, session)
```
Loads `{mouse}_{session}_liftLockedRT.mat`, runs `rtClassifier`.

### loadTargetXTClassifier.m
```matlab
function output = loadTargetXTClassifier(dataPath, mouse, session)
```
Loads `{mouse}_{session}_cueLockedXT.mat`, runs `targetXTClassifier`.

### loadTargetPartialClassifier.m
```matlab
function output = loadTargetPartialClassifier(dataPath, mouse, session)
```
Loads `{mouse}_{session}_cueLocked.mat` (with kinematics), runs `targetPartialClassifier`.

## plots/

### plotTargetClassifierProj.m
```matlab
function plotTargetClassifierProj(output, field, plotCrosstimes)
```
Single-trial projection traces onto classifier dimension. Time runs vertically, decoded choice horizontally. Blue=left, red=right.

```matlab
plotTargetClassifierProj(outputsLR(1).M1, 'projnorm')
```

### plotTargetClassifierTimingAll.m
```matlab
function plotTargetClassifierTimingAll(output)
```
Violin distributions of threshold crossing times, M1 (magenta) vs S1 (green). Performs Wilcoxon rank-sum test per mouse.

### plotRTClassifierCorrelationAll.m
```matlab
function plotRTClassifierCorrelationAll(outputs, eventName, method)
```
Pearson correlation between real and decoded reaction times for all mice, M1 vs S1. Connected dots per mouse with rank-sum test.

### plotTargetXTPerformanceAll.m
```matlab
function plotTargetXTPerformanceAll(outputs)
```
Cross-temporal generalization heatmaps. 5 mice in rows, M1 and S1 as column groups. Parula colormap.

### plotTargetClassifierPerformanceAll.m
```matlab
function plotTargetClassifierPerformanceAll(outputs)
```
Time-resolved classifier accuracy. Grand-mean +/- SEM panel followed by per-mouse panels. M1 in magenta, S1 in green, chance at 50%.

---

# preproc/ — Preprocessing & Data Loading

## Event Locking — Kinematics

### eventLockKinematics.m
```matlab
function data = eventLockKinematics(R, M, eventName, tPts, varargin)
```
Smooths and time-locks 3D DLC tracking data to a behavioral event. Core kinematic locking function.

- **R** — struct array from mergeDLC3R (one per trial)
- **M** — metadata struct with `.plotParams.spoutPose`
- **eventName** — field name to lock to (e.g., `'grabTime'`)
- **tPts** — evenly-spaced time vector (e.g., `-200:10:300`)
- **Name-value options:**
  - `'smooth'` (1) — enable smoothing
  - `'smoothMethod'` (`'Gaussian'`) — `'Gaussian'` or `'sgolay'`
  - `'gaussSD'` (15) — Gaussian std dev in ms
  - `'sgolayPoly'` (2), `'sgolayWindow'` (40) — Savitzky-Golay params
  - `'addMatrix'` (0) — reshape 3D to 2D
  - `'centroidMarkers'` (9:12) — markers for centroid
  - `'addVelocity'`/`'addAcceleration'`/`'addJoints'`/`'addCentroid'` (all 1) — feature flags
- **Returns** struct array with: `.posXYZ`, `.velXYZ`, `.accXYZ`, `.jointAngles`, `.jointVelocities`, `.aperture`, `.CposXYZ`, `.CvelXYZ`, `.dist2Spout`, `.contactBins`, etc.

Pipeline: smooth position -> diff for velocity -> smooth velocity -> diff for acceleration -> smooth acceleration. Same for joints. Aperture via Heron's formula on wrist-digit triangles.

### multiEventLockKinematics.m
```matlab
function data = multiEventLockKinematics(R, M, eventNames, preT, postT, tBase, lags, varargin)
```
Locks kinematics to two events simultaneously (e.g., lift and grab) with variable inter-event interval. Supports time lags for lagged analysis.

- **eventNames** — cell array of two field names
- **preT** — time before first event
- **postT** — time after second event, or `'equal'` for symmetric
- **tBase** — time step (ms)
- **lags** — lag values for shifted copies

Additional outputs: `.eventInterval`, `.linkLengths`, `.lag#jointAngles`.

## Event Locking — Neural

### eventLockData.m
```matlab
function data = eventLockData(R, M, eventName, tPts, rois)
```
Resamples deconvolved calcium events to custom timebase with sub-frame alignment. Uses proportional bin-overlap method (not interpolation). Corrects for ROI-specific scanning lags.

- **R** — struct with `.events`, `.frameTimes`, `.syncTime`
- **M** — struct with `.cycleDurMs`, `.ROILags`
- **Returns** struct with `.data` (nTimePoints x nROIs), `.locked`

### eventLockDataSmooth.m
```matlab
function data = eventLockDataSmooth(R, M, eventName, tPts, varargin)
```
Wrapper: `eventLockData` + Gaussian smoothing with edge padding (2 extra SDs on each side to avoid boundary artifacts).

- **varargin:** smoothSD (default 50), rois, field (`'events'`/`'rawFluor'`/`'denoised'`)

### eventLockRADICaL.m
```matlab
function neurons = eventLockRADICaL(neurons, R, tPts, tPtsRADICaL, field)
```
Extracts RADICaL rate estimates for time bins matching `tPts` from the full `tPtsRADICaL` window.

## Pipeline Wrappers

### lockNeural4Classifier.m
```matlab
function [neurons, config, M] = lockNeural4Classifier(R, M, config)
```
Selects top 100 modulated neurons (by min ZETA p-value across waterTime, liftTimeDLC, grabTimeC), locks and smooths, adds RT annotations.

### loadLock4Decode.m
```matlab
function [kinematics, neurons, M, config] = loadLock4Decode(mouse, session, config)
```
Full pipeline: `loadData` -> `eventLockDataSmooth` + `eventLockRADICaL` + `eventLockKinematics`. Keeps ALL neurons. Default: preT=-100, postT=400, tBase=10, smoothSD=35, event=liftTimeDLC.

### loadLock4Classifier.m
```matlab
function [neurons, M, config, kinematics] = loadLock4Classifier(mouse, session, config)
```
Full pipeline for classification. Uses `lockNeural4Classifier` (top 100 neurons). Kinematics only computed if 4th output requested.

### loadLockSave.m (Script)
Batch processes 10 datasets (5 mice x 2 sessions) into 4 locked file types:
1. Kinematics decoding: liftTimeDLC-locked, -200:10:800, smoothSD=35
2. Target classification: waterTime-locked, -100:10:500, smoothSD=35, top 100 neurons
3. RT classification: liftTimeDLC-locked, -200:10:600, smoothSD=10, top 100 neurons
4. Cross-time: waterTime-locked, -100:10:1000, smoothSD=10, top 100 neurons

## Batch Loaders

### loadEventTimes.m
```matlab
function eventInfo = loadEventTimes(datasets, dataPath)
```
Loads combined datasets and extracts behavioral timing: liftRT, contactRT, lift2ZoneTimes, lift2ContactTimes, graspTimes, nGrasps. All separated by L/R.

### loadLockKinematicsAll.m
```matlab
function kinematicsAll = loadLockKinematicsAll(datasets, dataPath)
```
Batch load + single-event lock kinematics (liftTimeDLC, preT=-100, postT=400, gaussSD=15). 

### loadMultilockKinematicsAll.m
```matlab
function kinematicsAll = loadMultilockKinematicsAll(datasets, dataPath)
```
Batch load + dual-event lock kinematics (liftTimeDLC + zoneTime). Calls `apertureFeatures()` to add aperture-derived events.

### loadCombinedModscores.m
```matlab
function modScores = loadCombinedModscores(datasets, dataPath, eventName)
```
Concatenates ZETA modulation p-values across all datasets for a given event.

---

# utils/ — Utility Functions

## Data Loading

### loadData.m
```matlab
function [R, M, config] = loadData(mouseName, sessionDate, prefix, suffix, folder, verbose)
```
Central data loader. Constructs filename pattern `prefix,mouseName_20sessionDate_*suffix.mat`, finds the match, loads R (trials) and M (metadata). Adds 24 joint name metadata to M. Falls back to behavior-only files if needed.

```matlab
[R, M, config] = loadData('cfa17', '200825', 'R', 'DLC3', YOURDATAPATH)
```

### loadCombinedDataset.m
```matlab
function R = loadCombinedDataset(dataset, dataPath)
```
Loads two sessions from the same mouse and concatenates, keeping 11 behavioral fields (success, grabTimeC, waterTime, liftTimeDLC, movementTime, liftRT, LR, goodDLC, wrongGrabFirst, zoneTime, nGrabs1000).

### keepFields.m
```matlab
function sOut = keepFields(sIn, keepList)
```
Retains only specified fields in a struct array, removing all others via `rmfield`.

## Smoothing & Math

### gaussFilt1.m
```matlab
function x = gaussFilt1(x, sd, dim)
```
1D Gaussian filtering on any dimension of an N-D array. Filter length = ceil(sd*8), forced odd. Uses `imgaussfilt` with symmetric padding. By Matt Kaufman.

- **sd** — standard deviation in sample units
- **dim** — (optional, default 1) dimension to filter

### eucDists.m
```matlab
function dists = eucDists(X)
```
Vectorized pairwise Euclidean distances between columns. Uses `||a-b||^2 = ||a||^2 + ||b||^2 - 2*a'b` identity. Returns NxN symmetric matrix.

### rotatePoints.m
```matlab
function rotatedData = rotatePoints(alignmentVector, originalData)
```
Rotates 2D or 3D points to align with a direction vector. 2D: simple rotation matrix. 3D: Rz around Z-axis, then Rodrigues rotation for elevation.

## Trial Grouping

### timeClus.m
```matlab
function [R, M] = timeClus(R, M, field)
```
Median-splits trials into fast/slow groups for L and R separately. Clusters: 1=L-fast, 2=L-slow, 3=R-fast, 4=R-slow. Assigns colormaps (blues for left, oranges/reds for right; darker=slower).

```matlab
[R, M] = timeClus(R, M, 'movementTime')
```

## Plotting — Figures & Axes

### fig.m
```matlab
function [hF, tl] = fig(layout, position, color)
```
Creates figure with `tiledlayout` and consistent styling (tick direction out, compact spacing).

- **layout** — `[]` or `[rows, cols]`
- **position** — `[x y w h]` or `'full'` for fullscreen
- **color** — background (default white)

```matlab
[hF, tl] = fig([2,3], [500 500 800 600])
```

### AxisMMC.m
```matlab
function outParams = AxisMMC(start, fin, params)
```
Publication-quality custom axis with manual ticks, labels, and offsets. By Mark Churchland (MKsort package, GPL v2). Supports horizontal/vertical orientation, inverted axes, custom fonts.

Key params: `.tickLocations`, `.tickLabels`, `.axisLabel`, `.axisOffset`, `.axisOrientation` (`'h'`/`'v'`), `.lineThickness`, `.fontSize`.

### plotBox.m
```matlab
function plotbox(ax, data, axloc, color, alpha, bxw, lw, msize, plotY)
```
Custom boxplot with median line, median dot, IQR box, whiskers (to non-outlier extremes), outlier dots, and optional jittered raw data. Outliers = beyond Q1/Q3 +/- 1.5*IQR.

### setXYLim.m
```matlab
function setXYLim(ax, setX, setY, spacers)
```
Auto-fits axis limits to all plotted data with optional `[xmin, xmax, ymin, ymax]` padding.

### printFigs.m
```matlab
function printFigs(figNums, folderName, format, fileTitles, landscape)
```
Batch exports figures to file. Supported formats: `-dpdf`, `-djpeg`, `-dtiff`, `-dill` (Illustrator), `-depsc2`, `-dpdfbf` (bestfit), `-dpdffp` (fillpage). 300 DPI, painters renderer.

## Plotting — 3D Skeleton & Traces

### drawSkeleton.m
```matlab
function hSkeleton = drawSkeleton(hA, data, config, hSkeleton)
```
Draws skeleton links (lines between connected markers) in 3D. Config: `.skeleton2Plot` (Nx2 link pairs), `.markers2Plot`, `.linkColors`, `.linkLineWidth`. Supports animation via handle reuse.

### drawMarkers.m
```matlab
function hMarkers = drawMarkers(hA, data, config, hMarkers)
```
Draws body markers as colored dots in 3D. Config: `.markers2Plot`, `.markerColors`, `.markerSizes`. Supports animation via handle reuse.

### drawTrace.m
```matlab
function hTrace = drawTrace(hA, data, config, hTrace)
```
Draws 3D trajectory traces. Modes: scatter, line, or time-colored (interpolated patch). Config: `.traceColors`, `.traceType`, `.traceAlpha`, `.traceLineWidth`. Supports animation.

### drawFill.m
```matlab
function hFill = drawFill(hA, data, config, hFill)
```
Draws filled polygons in 3D connecting specified markers (e.g., paw aperture). Config: `.markers2Fill`, `.fillColor`, `.fillAlpha`.

### coordAxes.m
```matlab
function coordAxes(ax, origin, scale, fontSize, flips, letters)
```
Draws 3D XYZ coordinate reference frame at a specified origin. `flips` = [fx, fy, fz] direction multipliers. `letters` = optional labels (default {'X','Y','Z'}).

### arrow3D.m
```matlab
function arrow3D(pos, deltaValues, colorCode, stemRatio)
```
Draws a 3D arrow (cylinder stem + cone head) using `surf()`. `stemRatio` = fraction of total length for the stem.

## Plotting — Color & Brain Maps

### colormapHSV.m
```matlab
function colormap = colormapHSV(colormap, hueMultiplier, satMultiplier, valMultiplier)
```
Modifies RGB colormap by adjusting H/S/V channels independently. Empty multiplier = skip. Per-row or scalar multipliers supported.

### turbo.m
```matlab
function map = turbo(m)
```
Turbo colormap — perceptually uniform alternative to jet. 256-entry hardcoded LUT, interpolated to `m` entries via `interp1`.

### diverging_map.m
```matlab
function [map] = diverging_map(s, rgb1, rgb2)
```
Perceptually uniform diverging colormap between two endpoints through white midpoint. Kenneth Moreland algorithm. Converts through RGB->XYZ->Lab->Msh color spaces.

### allenMapPolyCentered.m
```matlab
function allenMapPolyCentered(dorsalMaps, bregma, side, colorFill, scaleBar, hAx)
```
Renders Allen Brain Atlas dorsal cortical map using polygon outlines centered on bregma. Labels cortical areas. Used by `plotFOVsAllenCCF`.

### allenDorsalMap.mat (Data File)
Precomputed Allen Brain Atlas dorsal surface mapping. Contains `.edgeOutlineSplit`, `.sidesSplit`, `.labelsSplit`, `.desiredPixelSize`. Loaded by `plotFOVsAllenCCF` and `allenMapPolyCentered`.

---
